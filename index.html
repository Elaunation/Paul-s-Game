<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paul's Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .player-inputs {
            margin-top: 20px;
        }

        .player-input {
            margin-bottom: 15px;
        }

        .initials-display {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .initial-pair {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 5px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .back-button {
            background: #6c757d;
            margin-top: 10px;
        }

        .sentence-display {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-size: 1.1em;
            color: #333;
            font-weight: 600;
        }

        /* Timer Settings */
        .timer-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .timer-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            background: #e0e0e0;
            color: #333;
            border: 2px solid #999;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .timer-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        /* Gameplay Screen */
        .game-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .main-game {
            min-width: 0;
        }

        .side-panel {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            max-height: 600px;
            overflow-y: auto;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .current-player {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
        }

        .timer.warning {
            color: #ff9800;
        }

        .timer.danger {
            color: #f44336;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .current-initial {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            font-size: 2em;
            font-weight: bold;
        }

        .name-input-group {
            margin: 20px 0;
        }

        .name-input-group input {
            font-size: 18px;
            padding: 15px;
        }

        .submit-btn {
            background: #4caf50;
        }

        .submit-btn:hover {
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .skip-btn {
            background: #ff9800;
            margin-top: 10px;
        }

        .skip-btn:hover {
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        .scores-display {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 5px;
            font-weight: 600;
        }

        .score-item.current {
            background: #e8f4f8;
            border-left: 4px solid #667eea;
        }

        .score-item.winner {
            background: #c8e6c9;
            border-left: 4px solid #4caf50;
        }

        .validation-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
        }

        .validation-message.valid {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .validation-message.invalid {
            background: #ffcdd2;
            color: #c62828;
        }

        .initials-used-list {
            margin-top: 15px;
        }

        .initial-used-item {
            background: white;
            padding: 10px;
            margin: 8px 0;
            border-radius: 5px;
        }

        .initial-used-item h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .initial-used-item.completed {
            background: #c8e6c9;
        }

        .initial-used-item ul {
            list-style: none;
            padding-left: 10px;
        }

        .initial-used-item li {
            font-size: 14px;
            color: #666;
            padding: 2px 0;
        }

        /* Win Screen */
        .win-screen {
            text-align: center;
        }

        .win-celebration {
            font-size: 4em;
            margin: 20px 0;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .win-message {
            font-size: 2em;
            color: #667eea;
            margin: 20px 0;
            font-weight: bold;
        }

        .final-scores {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-selection {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-selection h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .player-btn {
            background: #667eea;
            color: white;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .player-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .player-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .reset-game-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
            z-index: 1000;
            width: auto;
        }

        .reset-game-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .game-layout {
                grid-template-columns: 1fr;
            }
            
            .reset-game-btn {
                bottom: 10px;
                right: 10px;
                padding: 8px 16px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎮 Paul's Game</h1>
        
        <button class="reset-game-btn" onclick="restartGame()" title="Restart game from beginning">🔄 Restart Game</button>

        <!-- Screen 1: Player Count Selection -->
        <div id="playerCountScreen" class="screen active">
            <div class="input-group">
                <label for="playerCount">How many players? (1-6)</label>
                <input type="number" id="playerCount" min="1" max="6" value="2">
            </div>
            <button onclick="setupPlayers()">Next</button>
        </div>

        <!-- Screen 2: Player Names -->
        <div id="playerNamesScreen" class="screen">
            <div id="playerInputs" class="player-inputs"></div>
            <button onclick="startGame()">Start Game</button>
            <button class="back-button" onclick="showScreen('playerCountScreen')">Back</button>
        </div>

        <!-- Screen 3: Sentence Input -->
        <div id="sentenceScreen" class="screen">
            <div class="input-group">
                <label for="sentence">Enter a sentence (e.g., "Cat Ate Rice")</label>
                <input type="text" id="sentence" placeholder="Type your sentence here...">
                <p class="info-text">The first letters will be extracted and paired with the alphabet!</p>
            </div>
            <button onclick="generateInitials()">Generate Initials</button>
            <button class="back-button" onclick="showScreen('playerNamesScreen')">Back</button>
        </div>

        <!-- Screen 4: Initials Display & Timer Setup -->
        <div id="initialsScreen" class="screen">
            <div class="sentence-display" id="sentenceDisplay"></div>
            <div class="initials-display" id="initialsDisplay"></div>
            
            <div class="input-group">
                <label>Select Timer Duration (seconds)</label>
                <div class="timer-options">
                    <button class="timer-btn active" onclick="selectTimer(45)">45s</button>
                    <button class="timer-btn" onclick="selectTimer(60)">60s</button>
                    <button class="timer-btn" onclick="selectTimer(75)">75s</button>
                    <button class="timer-btn" onclick="selectTimer(90)">90s</button>
                </div>
            </div>

            <button onclick="startGameplay()">Start Gameplay</button>
            <button class="back-button" onclick="showScreen('sentenceScreen')">Back</button>
        </div>

        <!-- Screen 5: Gameplay -->
        <div id="gameplayScreen" class="screen">
            <div class="game-layout">
                <div class="main-game">
                    <div class="game-header">
                        <div class="current-player" id="currentPlayerDisplay"></div>
                        <div class="timer" id="timerDisplay">60</div>
                    </div>

                    <div class="current-initial" id="currentInitialDisplay"></div>

                    <div class="name-input-group">
                        <label for="nameInput">Enter a famous person's name:</label>
                        <input type="text" id="nameInput" placeholder="e.g., Charlie Chaplin" autocomplete="off">
                        <div id="validationMessage"></div>
                    </div>

                    <button class="submit-btn" onclick="submitName()">Submit Name (1 point)</button>
                    <button class="skip-btn" onclick="skipTurn()">Skip Turn</button>
                </div>

                <div class="side-panel">
                    <div class="scores-display" id="scoresDisplay"></div>
                    <div class="initials-used-list" id="initialsUsedList"></div>
                </div>
            </div>
        </div>

        <!-- Screen 6: Player Selection -->
        <div id="playerSelectionScreen" class="screen">
            <div class="player-selection">
                <h3>⏱️ Time's up! All initials have been answered.</h3>
                <p style="margin: 15px 0; color: #666;">Select the next player to continue:</p>
                <div id="playerSelectionButtons"></div>
            </div>
        </div>

        <!-- Screen 7: Win Screen -->
        <div id="winScreen" class="screen">
            <div class="win-screen">
                <div class="win-celebration" id="winCelebration">🎉</div>
                <div class="win-message" id="winMessage"></div>
                <div class="final-scores" id="finalScores"></div>
                <button onclick="resetGame()">Play Again</button>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let currentPlayerIndex = 0;
        let currentSentence = '';
        let initialPairs = [];
        let selectedTimer = 45;
        let timeRemaining = 45;
        let timerInterval = null;
        let gameActive = false;
        let currentInitialIndex = 0;
        let submittedNames = {};
        let isValidating = false;
        let playersWhoPlayed = new Set();
        let lastAlphabetIndex = -1; // Track the last alphabet index used
        const WINNING_SCORE = 10;

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function setupPlayers() {
            const count = parseInt(document.getElementById('playerCount').value);
            
            if (count < 1 || count > 6) {
                alert('Please enter a number between 1 and 6');
                return;
            }

            const playerInputsDiv = document.getElementById('playerInputs');
            playerInputsDiv.innerHTML = '';

            for (let i = 1; i <= count; i++) {
                const div = document.createElement('div');
                div.className = 'player-input';
                div.innerHTML = `
                    <label for="player${i}">Player ${i} Name</label>
                    <input type="text" id="player${i}" placeholder="Enter name" required>
                `;
                playerInputsDiv.appendChild(div);
            }

            showScreen('playerNamesScreen');
        }

        function startGame() {
            const count = parseInt(document.getElementById('playerCount').value);
            players = [];

            for (let i = 1; i <= count; i++) {
                const name = document.getElementById(`player${i}`).value.trim();
                if (!name) {
                    alert(`Please enter a name for Player ${i}`);
                    return;
                }
                players.push({ name: name, score: 0 });
            }

            showScreen('sentenceScreen');
        }

        function generateInitials() {
            const sentence = document.getElementById('sentence').value.trim();
            
            if (!sentence) {
                alert('Please enter a sentence');
                return;
            }

            currentSentence = sentence;
            
            const words = sentence.split(' ').filter(word => word.length > 0);
            const firstLetters = words.map(word => word[0].toUpperCase());

            // Clear previous round's initials - start fresh for this round
            initialPairs = [];
            
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            
            // Continue from the last alphabet index used
            for (let i = 0; i < firstLetters.length; i++) {
                lastAlphabetIndex++;
                if (lastAlphabetIndex >= alphabet.length) {
                    alert('You have used all letters of the alphabet! Starting over from A.');
                    lastAlphabetIndex = 0;
                }
                const pair = firstLetters[i] + alphabet[lastAlphabetIndex];
                initialPairs.push(pair);
            }

            document.getElementById('sentenceDisplay').textContent = `Sentence: "${sentence}"`;
            
            const initialsDiv = document.getElementById('initialsDisplay');
            initialsDiv.innerHTML = '<h3 style="margin-bottom: 15px; color: #333;">Generated Initials:</h3>';
            
            initialPairs.forEach((pair, index) => {
                const span = document.createElement('span');
                span.className = 'initial-pair';
                span.textContent = pair;
                initialsDiv.appendChild(span);
            });

            showScreen('initialsScreen');
        }

        function selectTimer(seconds) {
            selectedTimer = seconds;
            document.querySelectorAll('.timer-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function startGameplay() {
            if (initialPairs.length === 0) {
                alert('Please generate initials first');
                return;
            }

            timeRemaining = selectedTimer;
            currentPlayerIndex = 0;
            currentInitialIndex = 0;
            playersWhoPlayed.clear();
            gameActive = true;

            // Initialize submitted names for this round's initials
            submittedNames = {};
            initialPairs.forEach(pair => {
                submittedNames[pair] = [];
            });

            showScreen('gameplayScreen');
            updateGameDisplay();
            startTimer();
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            updateTimerDisplay(); // Show initial time immediately
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    gameActive = false;
                    handleTimeUp();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.textContent = timeRemaining;
            timerDisplay.classList.remove('warning', 'danger');
            
            if (timeRemaining <= 10) {
                timerDisplay.classList.add('danger');
            } else if (timeRemaining <= 20) {
                timerDisplay.classList.add('warning');
            }
        }

        function updateGameDisplay() {
            const currentPlayer = players[currentPlayerIndex];
            document.getElementById('currentPlayerDisplay').textContent = `${currentPlayer.name}'s Turn`;
            
            // Update timer display immediately
            document.getElementById('timerDisplay').textContent = timeRemaining;
            
            const currentInitial = initialPairs[currentInitialIndex];
            document.getElementById('currentInitialDisplay').textContent = currentInitial;

            updateScoresDisplay();
            updateInitialsUsedDisplay();
            document.getElementById('nameInput').value = '';
            document.getElementById('validationMessage').innerHTML = '';
            document.getElementById('nameInput').focus();
        }

        function updateScoresDisplay() {
            const scoresDiv = document.getElementById('scoresDisplay');
            scoresDiv.innerHTML = '<h3 style="margin-bottom: 10px; color: #333;">Scores:</h3>';
            
            players.forEach((player, index) => {
                const scoreItem = document.createElement('div');
                let className = 'score-item';
                if (index === currentPlayerIndex) className += ' current';
                if (player.score >= WINNING_SCORE) className += ' winner';
                scoreItem.className = className;
                scoreItem.innerHTML = `<span>${player.name}</span><span>${player.score} pts</span>`;
                scoresDiv.appendChild(scoreItem);
            });
        }

        function updateInitialsUsedDisplay() {
            const listDiv = document.getElementById('initialsUsedList');
            listDiv.innerHTML = '<h3 style="margin-bottom: 10px; color: #333;">Used Names:</h3>';
            
            // Only show initials from the current round
            if (initialPairs.length === 0) {
                listDiv.innerHTML += '<p style="color: #999; font-size: 14px;">No initials yet</p>';
                return;
            }
            
            initialPairs.forEach(pair => {
                const names = submittedNames[pair] || [];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'initial-used-item' + (names.length > 0 ? ' completed' : '');
                
                let html = `<h4>${pair}</h4>`;
                if (names.length === 0) {
                    html += '<p style="font-size: 12px; color: #999;">No names yet</p>';
                } else {
                    html += '<ul>';
                    names.forEach(name => {
                        html += `<li>✓ ${name}</li>`;
                    });
                    html += '</ul>';
                }
                
                itemDiv.innerHTML = html;
                listDiv.appendChild(itemDiv);
            });
        }

        function checkInitials(name, requiredInitials) {
            const words = name.trim().split(/\s+/).filter(word => word.length > 0);
            
            if (words.length < 2) {
                return false;
            }
            
            const firstInitial = words[0][0].toUpperCase();
            const lastInitial = words[words.length - 1][0].toUpperCase();
            const nameInitials = firstInitial + lastInitial;
            
            return nameInitials === requiredInitials;
        }

        async function validateName(name) {
            const currentInitial = initialPairs[currentInitialIndex];
            const nameUpper = name.toUpperCase();
            
            // Check if already submitted for ANY initial in current round
            for (let pair in submittedNames) {
                if (submittedNames[pair].some(n => n.toUpperCase() === nameUpper)) {
                    return { valid: false, message: '❌ This name was already used!' };
                }
            }

            // Check if initials match
            if (!checkInitials(name, currentInitial)) {
                return { 
                    valid: false, 
                    message: `❌ Name doesn't match initials ${currentInitial}!` 
                };
            }

            // Use Wikipedia API to verify if this is a famous PERSON
            try {
                const wikiResponse = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(name)}&limit=5&format=json&origin=*`
                );
                const wikiData = await wikiResponse.json();
                
                if (wikiData[1] && wikiData[1].length > 0) {
                    // Check if any of the results match the name closely
                    const exactMatch = wikiData[1].some(result => 
                        result.toLowerCase() === name.toLowerCase()
                    );
                    
                    if (exactMatch) {
                        // Additional check: fetch the page to verify it's a person
                        const pageTitle = wikiData[1].find(result => 
                            result.toLowerCase() === name.toLowerCase()
                        );
                        
                        const pageResponse = await fetch(
                            `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(pageTitle)}&prop=categories&format=json&origin=*`
                        );
                        const pageData = await pageResponse.json();
                        
                        // Check if the page has categories that indicate it's a person
                        const pages = pageData.query.pages;
                        const pageId = Object.keys(pages)[0];
                        const categories = pages[pageId].categories || [];
                        
                        // Look for common person-related categories
                        const isPersonCategory = categories.some(cat => {
                            const catTitle = cat.title.toLowerCase();
                            return catTitle.includes('births') || 
                                   catTitle.includes('deaths') || 
                                   catTitle.includes('people') ||
                                   catTitle.includes('actors') ||
                                   catTitle.includes('actresses') ||
                                   catTitle.includes('singers') ||
                                   catTitle.includes('musicians') ||
                                   catTitle.includes('athletes') ||
                                   catTitle.includes('politicians') ||
                                   catTitle.includes('writers') ||
                                   catTitle.includes('directors') ||
                                   catTitle.includes('artists') ||
                                   catTitle.includes('performers') ||
                                   catTitle.includes('celebrities') ||
                                   catTitle.includes('composers') ||
                                   catTitle.includes('authors') ||
                                   catTitle.includes('poets') ||
                                   catTitle.includes('painters') ||
                                   catTitle.includes('sculptors') ||
                                   catTitle.includes('photographers') ||
                                   catTitle.includes('dancers') ||
                                   catTitle.includes('comedians') ||
                                   catTitle.includes('rappers') ||
                                   catTitle.includes('producers') ||
                                   catTitle.includes('scientists') ||
                                   catTitle.includes('inventors') ||
                                   catTitle.includes('entrepreneurs') ||
                                   catTitle.includes('businesspeople') ||
                                   catTitle.includes('activists') ||
                                   catTitle.includes('philosophers') ||
                                   catTitle.includes('historians') ||
                                   catTitle.includes('journalists') ||
                                   catTitle.includes('broadcasters') ||
                                   catTitle.includes('models') ||
                                   catTitle.includes('designers') ||
                                   catTitle.includes('architects') ||
                                   catTitle.includes('chefs') ||
                                   catTitle.includes('engineers') ||
                                   catTitle.includes('educators') ||
                                   catTitle.includes('military') ||
                                   catTitle.includes('explorers') ||
                                   catTitle.includes('astronauts') ||
                                   catTitle.includes('religious figures') ||
                                   catTitle.includes('clergy') ||
                                   catTitle.includes('royalty') ||
                                   catTitle.includes('nobility');
                        });
                        
                        if (isPersonCategory || categories.length === 0) {
                            // If we can't determine or it looks like a person, accept it
                            return { valid: true, message: '✅ Valid! +1 point' };
                        } else {
                            return { 
                                valid: false, 
                                message: '❌ Must be a person\'s name, not a company or thing!' 
                            };
                        }
                    }
                }
                
                return { 
                    valid: false, 
                    message: '❌ Not recognized as a famous person. Try another!' 
                };
                
            } catch (error) {
                console.error('Validation error:', error);
                return { 
                    valid: false, 
                    message: '❌ Could not verify name. Check your connection.' 
                };
            }
        }

        async function submitName() {
            if (!gameActive) {
                alert('Round is over!');
                return;
            }

            if (isValidating) {
                return;
            }

            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Please enter a name');
                return;
            }

            const messageDiv = document.getElementById('validationMessage');
            messageDiv.className = 'validation-message';
            messageDiv.textContent = '🔍 Validating...';
            
            isValidating = true;
            const submitBtn = document.querySelector('.submit-btn');
            submitBtn.disabled = true;

            const validation = await validateName(name);
            
            isValidating = false;
            submitBtn.disabled = false;
            
            messageDiv.className = 'validation-message ' + (validation.valid ? 'valid' : 'invalid');
            messageDiv.textContent = validation.message;

            if (validation.valid) {
                const currentInitial = initialPairs[currentInitialIndex];
                submittedNames[currentInitial].push(name);
                
                // Add to existing score - this accumulates across rounds
                players[currentPlayerIndex].score = players[currentPlayerIndex].score + 1;
                
                // Check for winner
                if (players[currentPlayerIndex].score >= WINNING_SCORE) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    gameActive = false;
                    showWinScreen();
                    return;
                }
                
                setTimeout(() => {
                    nextTurn();
                }, 1500);
            }
        }

        function skipTurn() {
            if (!gameActive) return;
            nextTurn();
        }

        function nextTurn() {
            currentInitialIndex++;
            
            // Check if we've gone through all initials for this round
            if (currentInitialIndex >= initialPairs.length) {
                currentInitialIndex = 0;
            }

            updateGameDisplay();
        }

        function handleTimeUp() {
            // Clear the timer interval
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            playersWhoPlayed.add(currentPlayerIndex);
            
            // Check if all players have played
            if (playersWhoPlayed.size >= players.length) {
                // All players played, but no one reached 10 points
                // Reset for new round but keep scores and alphabet position
                alert('All players have had their turn! No one reached 10 points yet. Starting a new round - enter a new sentence!');
                
                // Reset for new round but KEEP scores and lastAlphabetIndex
                playersWhoPlayed.clear();
                
                // Clear the initials and submitted names for the new round
                initialPairs = [];
                submittedNames = {};
                
                // Go back to sentence screen to start new round
                showScreen('sentenceScreen');
                document.getElementById('sentence').value = '';
            } else {
                // Show player selection for next turn
                showPlayerSelection();
            }
        }

        function showPlayerSelection() {
            const buttonsDiv = document.getElementById('playerSelectionButtons');
            buttonsDiv.innerHTML = '';
            
            players.forEach((player, index) => {
                const btn = document.createElement('button');
                btn.className = 'player-btn';
                btn.textContent = player.name + ` (${player.score} pts)`;
                btn.disabled = playersWhoPlayed.has(index);
                btn.onclick = () => selectNextPlayer(index);
                buttonsDiv.appendChild(btn);
            });
            
            showScreen('playerSelectionScreen');
        }

        function selectNextPlayer(playerIndex) {
            currentPlayerIndex = playerIndex;
            timeRemaining = selectedTimer;
            currentInitialIndex = 0;
            gameActive = true;
            
            // Clear validation message from previous turn
            document.getElementById('validationMessage').innerHTML = '';
            document.getElementById('nameInput').value = '';
            
            showScreen('gameplayScreen');
            updateGameDisplay();
            
            // Ensure timer starts fresh
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            startTimer();
        }

        function showWinScreen() {
            const winner = players.reduce((max, player) => 
                player.score > max.score ? player : max
            );
            
            // Get a random name from submitted names for celebration
            const allNames = Object.values(submittedNames).flat();
            const randomName = allNames[Math.floor(Math.random() * allNames.length)] || winner.name;
            
            document.getElementById('winCelebration').textContent = '🎉👑🎊';
            document.getElementById('winMessage').textContent = `${winner.name} Wins with ${winner.score} points!`;
            
            const finalScoresDiv = document.getElementById('finalScores');
            finalScoresDiv.innerHTML = '<h3 style="margin-bottom: 15px;">Final Scores:</h3>';
            
            players.sort((a, b) => b.score - a.score).forEach((player, index) => {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item' + (index === 0 ? ' winner' : '');
                scoreItem.innerHTML = `
                    <span>${index + 1}. ${player.name}</span>
                    <span>${player.score} pts</span>
                `;
                finalScoresDiv.appendChild(scoreItem);
            });
            
            // Reset alphabet index when there's a winner
            lastAlphabetIndex = -1;
            
            showScreen('winScreen');
        }

        function resetGame() {
            players.forEach(player => player.score = 0);
            submittedNames = {};
            playersWhoPlayed.clear();
            currentPlayerIndex = 0;
            currentInitialIndex = 0;
            gameActive = false;
            if (timerInterval) clearInterval(timerInterval);
            
            showScreen('sentenceScreen');
            document.getElementById('sentence').value = '';
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('nameInput');
            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !isValidating) {
                    submitName();
                }
            });
        });

        function restartGame() {
            // Stop any active game session immediately
            gameActive = false;
            
            // Clear timer immediately
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Reset ALL variables to initial state
            players = [];
            submittedNames = {};
            playersWhoPlayed.clear();
            currentPlayerIndex = 0;
            currentInitialIndex = 0;
            initialPairs = [];
            lastAlphabetIndex = -1;
            currentSentence = '';
            timeRemaining = selectedTimer;
            isValidating = false;
            
            // Clear all input fields
            document.getElementById('playerCount').value = 2;
            const sentenceInput = document.getElementById('sentence');
            if (sentenceInput) sentenceInput.value = '';
            const nameInput = document.getElementById('nameInput');
            if (nameInput) nameInput.value = '';
            
            // Clear validation messages
            const validationDiv = document.getElementById('validationMessage');
            if (validationDiv) {
                validationDiv.innerHTML = '';
            }
            
            // Clear player inputs
            const playerInputsDiv = document.getElementById('playerInputs');
            if (playerInputsDiv) {
                playerInputsDiv.innerHTML = '';
            }
            
            // Go back to first screen to start from beginning
            showScreen('playerCountScreen');
        }

        function fullResetGame() {
            restartGame();
        }
    </script>
</body>
</html>
